–û—Ç–ª–∏—á–Ω–æ. –Ø —Å–µ–π—á–∞—Å **—Å—Ç—Ä–æ–≥–æ –æ–±—ä—è—Å–Ω—é —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∞–≤—Ç–æ—Ä**, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–≥–æ-–ª–∏–±–æ –æ—Ç —Å–µ–±—è.

---

# üî• Leaky Bucket (–ø—Ä–æ—Ç–µ–∫–∞—é—â–µ–µ –≤–µ–¥—Ä–æ) ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º rate limiting

–ê–≤—Ç–æ—Ä –≤ —ç—Ç–æ–º —É—Ä–æ–∫–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–º—É rate limiting –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **—Ç—Ä–µ—Ç—å—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é** ‚Äî **Leaky Bucket Algorithm**, –∞ —Ç–∞–∫–∂–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∏.

---

## –ö—Ä–∞—Ç–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ (–∫–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç –∞–≤—Ç–æ—Ä)

| –ê–ª–≥–æ—Ä–∏—Ç–º         | –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç                                  | –ü–ª—é—Å—ã                       | –ú–∏–Ω—É—Å—ã                             |
| ---------------- | --------------------------------------------- | --------------------------- | ---------------------------------- |
| Fixed Window     | –î–µ–ª–∏—Ç –≤—Ä–µ–º—è –Ω–∞ –æ–∫–Ω–∞ –∏ –¥–∞—ë—Ç N –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–∫–Ω–æ | –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π               | –î–∞—ë—Ç –≤—Å–ø–ª–µ—Å–∫–∏ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –æ–∫–æ–Ω     |
| Token Bucket     | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º    | –°–≥–ª–∞–∂–∏–≤–∞–µ—Ç –≤—Å–ø–ª–µ—Å–∫–∏, –≥–∏–±–∫–∏–π | –°–ª–æ–∂–Ω–µ–µ –∏ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤  |
| **Leaky Bucket** | –ó–∞–ø—Ä–æ—Å—ã ¬´–≤—ã—Ç–µ–∫–∞—é—Ç¬ª —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é     | –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–æ–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É | –ú–æ–∂–µ—Ç —Ç–µ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–µ |

---

# üì¶ –ò–¥–µ—è Leaky Bucket

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –≤–µ–¥—Ä–æ —Å –º–∞–ª–µ–Ω—å–∫–∏–º –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ–º —Å–Ω–∏–∑—É:

- –í–µ–¥—Ä–æ ‚Äî —ç—Ç–æ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤
- –í–æ–¥–∞ ‚Äî —ç—Ç–æ –∑–∞–ø—Ä–æ—Å—ã
- –û—Ç–≤–µ—Ä—Å—Ç–∏–µ ‚Äî —ç—Ç–æ **–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏**
- –í–µ–¥—Ä–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å—Å—è ‚Üí –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç **–æ—Ç–±—Ä–æ—à–µ–Ω—ã**

–ó–∞–ø—Ä–æ—Å—ã –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è **—Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ –∏—Ö –ø—Ä–∏—à–ª–æ.

## –ö–æ–¥ Leaky Bucket –∞–ª–≥–æ—Ä–∏—Ç–º–∞:

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ LeakyBucket

```go
type LeakyBucket struct {
    mu       sync.Mutex
    capacity int
    leakRate time.Duration
    tokens   int
    lastLeak time.Time
}
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π:**

- `capacity` (–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å): –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –≤–º–µ—Å—Ç–∏—Ç—å "–≤–µ–¥—Ä–æ"
- `leakRate` (—Å–∫–æ—Ä–æ—Å—Ç—å —É—Ç–µ—á–∫–∏): –∫–∞–∫ —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 500 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
- `tokens`: —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –≤–µ–¥—Ä–µ
- `lastLeak`: –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π "—É—Ç–µ—á–∫–∏" (–∫–æ–≥–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å —Ç–æ–∫–µ–Ω—ã)
- `mu`: –º—å—é—Ç–µ–∫—Å –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

### 2. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä NewLeakyBucket

```go
func NewLeakyBucket(capacity int, leakRate time.Duration) *LeakyBucket {
    return &LeakyBucket{
        capacity: capacity,
        leakRate: leakRate,
        tokens:   capacity,
        lastLeak: time.Now(),
    }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä LeakyBucket
- `tokens` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ä–∞–≤–Ω—ã–º `capacity` (–≤–µ–¥—Ä–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –≤ –Ω–∞—á–∞–ª–µ)
- `lastLeak` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

### 3. –ú–µ—Ç–æ–¥ Allow() - –ø–æ—à–∞–≥–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

```go
func (lb *LeakyBucket) Allow() bool {
    lb.mu.Lock()
    defer lb.mu.Unlock()

    now := time.Now()
    elapsed := now.Sub(lb.lastLeak)
    tokensToAdd := int(elapsed / lb.leakRate)
```

**–®–∞–≥ 1: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞**

- `lb.mu.Lock()` - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è –¥—Ä—É–≥–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω
- `defer lb.mu.Unlock()` - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–®–∞–≥ 2: –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏**

- `now := time.Now()` - –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
- `elapsed := now.Sub(lb.lastLeak)` - –≤—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Ç–µ—á–∫–∏
- `tokensToAdd := int(elapsed / lb.leakRate)` - –≤—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ tokensToAdd:**

- –ï—Å–ª–∏ `elapsed = 1.3 —Å–µ–∫—É–Ω–¥—ã`, `leakRate = 0.5 —Å–µ–∫—É–Ω–¥—ã`
- –¢–æ–≥–¥–∞: `1.3 / 0.5 = 2.6`
- –ü—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –≤ `int`: `2` (–¥—Ä–æ–±–Ω–∞—è —á–∞—Å—Ç—å –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)

```go
    lb.tokens += tokensToAdd
    if lb.tokens > lb.capacity {
        lb.tokens = lb.capacity
    }
```

**–®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤**

- –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: `lb.tokens += tokensToAdd`
- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –µ—Å–ª–∏ `tokens > capacity`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `tokens = capacity`

```go
    lb.lastLeak = lb.lastLeak.Add(time.Duration(tokensToAdd) * lb.leakRate)
```

**–®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Ç–µ—á–∫–∏**

- –û–±–Ω–æ–≤–ª—è–µ–º `lastLeak` —Å —É—á–µ—Ç–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **–í–∞–∂–Ω–æ**: –ú—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º `elapsed` –Ω–∞–ø—Ä—è–º—É—é, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –±—ã –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —É—á–µ—Ç—É –≤—Ä–µ–º–µ–Ω–∏

**–ü—Ä–∏–º–µ—Ä –ø–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å elapsed:**

- –ï—Å–ª–∏ `elapsed = 1.3 —Å–µ–∫—É–Ω–¥—ã`, `leakRate = 0.5 —Å–µ–∫—É–Ω–¥—ã`
- `tokensToAdd = 2` (—Ç–∞–∫ –∫–∞–∫ 1.3 / 0.5 = 2.6 ‚Üí int = 2)
- –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Å—å `elapsed` (1.3 —Å–µ–∫—É–Ω–¥—ã) –∫ `lastLeak`, —Ç–æ –º—ã –¥–æ–±–∞–≤–∏–º –ª–∏—à–Ω–µ–µ –≤—Ä–µ–º—è
- –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º: `2 * 0.5 = 1.0 —Å–µ–∫—É–Ω–¥—É`

```go
    if lb.tokens > 0 {
        lb.tokens--
        return true
    }
    return false
}
```

**–®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤**

- –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω—ã (`tokens > 0`):
  - –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ 1
  - –í–æ–∑–≤—Ä–∞—â–∞–µ–º `true` (–∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω)
- –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `false` (–∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω)

### 4. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è main()

```go
func main() {
    limiter := NewLeakyBucket(5, 500*time.Millisecond)

    for i := 0; i < 10; i++ {
        if limiter.Allow() {
            fmt.Println("request allowed")
        } else {
            fmt.Println("request denied")
        }
        time.Sleep(200 * time.Millisecond)
    }
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `capacity = 5` (5 —Ç–æ–∫–µ–Ω–æ–≤)
- `leakRate = 500ms` (–Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 500 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
- –ó–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 200 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥

### 5. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (console output):

```
request allowed
request allowed
request allowed
request allowed
request allowed
request allowed
request allowed
request denied
request allowed
request denied
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**

| –í—Ä–µ–º—è (–º—Å) | –¢–æ–∫–µ–Ω—ã –¥–æ | –î–æ–±–∞–≤–ª–µ–Ω–æ | –¢–æ–∫–µ–Ω—ã –ø–æ—Å–ª–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
| ---------- | --------- | --------- | ------------ | --------- |
| 0          | 5         | 0         | 4            | allowed   |
| 200        | 4         | 0         | 3            | allowed   |
| 400        | 3         | 0         | 2            | allowed   |
| 600        | 2         | 1         | 2            | allowed   |
| 800        | 2         | 0         | 1            | allowed   |
| 1000       | 1         | 1         | 1            | allowed   |
| 1200       | 1         | 0         | 0            | allowed   |
| 1400       | 0         | 0         | 0            | denied    |
| 1600       | 0         | 1         | 0            | allowed   |
| 1800       | 0         | 0         | 0            | denied    |

### –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `lastLeak`

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –∫–æ–¥ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –¥–æ–±–∞–≤–∏–≤ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ø—Ä–∏–Ω—Ç—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç–æ–∫–µ–Ω–æ–≤. –Ø –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é –∫–æ–¥ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏:

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

type LeakyBucket struct {
	mu       sync.Mutex
	capacity int
	leakRate time.Duration
	tokens   int
	lastLeak time.Time
}

func NewLeakyBucket(capacity int, leakRate time.Duration) *LeakyBucket {
	now := time.Now()
	fmt.Printf("NewLeakyBucket created at: %v\n", now)
	return &LeakyBucket{
		capacity: capacity,
		leakRate: leakRate,
		tokens:   capacity,
		lastLeak: now,
	}
}

func (lb *LeakyBucket) Allow() bool {
	lb.mu.Lock()
	defer lb.mu.Unlock()

	now := time.Now()
	elapsed := now.Sub(lb.lastLeak)
	tokensToAdd := int(elapsed / lb.leakRate)

	fmt.Printf("\n=== Allow() call ===\n")
	fmt.Printf("Current time: %v\n", now)
	fmt.Printf("Last leak time: %v\n", lb.lastLeak)
	fmt.Printf("Elapsed time: %v\n", elapsed)
	fmt.Printf("Tokens to add (elapsed/leakRate): %v / %v = %d\n",
		elapsed, lb.leakRate, tokensToAdd)

	lb.tokens += tokensToAdd
	if lb.tokens > lb.capacity {
		fmt.Printf("Tokens capped at capacity %d (was %d)\n", lb.capacity, lb.tokens)
		lb.tokens = lb.capacity
	}

	// –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: –∫–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è lastLeak
	oldLastLeak := lb.lastLeak
	lb.lastLeak = lb.lastLeak.Add(time.Duration(tokensToAdd) * lb.leakRate)
	fmt.Printf("Updating lastLeak: %v + (%d * %v) = %v\n",
		oldLastLeak, tokensToAdd, lb.leakRate, lb.lastLeak)

	if lb.tokens > 0 {
		fmt.Printf("Request allowed! Tokens before: %d, after: %d\n", lb.tokens, lb.tokens-1)
		lb.tokens--
		return true
	}
	fmt.Println("Request denied! No tokens available")
	return false
}

func main() {
	limiter := NewLeakyBucket(5, 500*time.Millisecond)

	for i := 0; i < 10; i++ {
		fmt.Printf("\n--- Iteration %d ---\n", i)
		if limiter.Allow() {
			fmt.Println("‚úÖ request allowed")
		} else {
			fmt.Println("‚ùå request denied")
		}
		time.Sleep(200 * time.Millisecond)
	}
}
```

---

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```
NewLeakyBucket created at: 2026-01-11 10:00:00 +0000 UTC
```

- `capacity = 5`
- `leakRate = 500ms`
- `tokens = 5` (–≤–µ–¥—Ä–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é)
- `lastLeak = 10:00:00`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 0 (10:00:00.000)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:00 +0000 UTC
Last leak time: 2026-01-11 10:00:00 +0000 UTC
Elapsed time: 0s
Tokens to add (elapsed/leakRate): 0s / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:00 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:00 +0000 UTC
Request allowed! Tokens before: 5, after: 4
‚úÖ request allowed
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –ü—Ä–æ—à–ª–æ 0ms —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Ç–µ—á–∫–∏ ‚Üí `tokensToAdd = 0`
- `lastLeak` –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º: `10:00:00 + 0 = 10:00:00`
- –¢–æ–∫–µ–Ω –ø–æ—Ç—Ä–∞—á–µ–Ω: `tokens = 4`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 1 (10:00:00.200)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:00.2 +0000 UTC
Last leak time: 2026-01-11 10:00:00 +0000 UTC
Elapsed time: 200ms
Tokens to add (elapsed/leakRate): 200ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:00 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:00 +0000 UTC
Request allowed! Tokens before: 4, after: 3
‚úÖ request allowed
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –ü—Ä–æ—à–ª–æ 200ms (< 500ms) ‚Üí `tokensToAdd = 0`
- `lastLeak` –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
- –¢–æ–∫–µ–Ω –ø–æ—Ç—Ä–∞—á–µ–Ω: `tokens = 3`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 2 (10:00:00.400)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:00.4 +0000 UTC
Last leak time: 2026-01-11 10:00:00 +0000 UTC
Elapsed time: 400ms
Tokens to add (elapsed/leakRate): 400ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:00 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:00 +0000 UTC
Request allowed! Tokens before: 3, after: 2
‚úÖ request allowed
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- 400ms < 500ms ‚Üí `tokensToAdd = 0`
- `lastLeak` –æ—Å—Ç–∞—ë—Ç—Å—è `10:00:00`
- –¢–æ–∫–µ–Ω –ø–æ—Ç—Ä–∞—á–µ–Ω: `tokens = 2`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 3 (10:00:00.600)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:00.6 +0000 UTC
Last leak time: 2026-01-11 10:00:00 +0000 UTC
Elapsed time: 600ms
Tokens to add (elapsed/leakRate): 600ms / 500ms = 1
Updating lastLeak: 2026-01-11 10:00:00 +0000 UTC + (1 * 500ms) = 2026-01-11 10:00:00.5 +0000 UTC
Request allowed! Tokens before: 3, after: 2
‚úÖ request allowed
```

**‚ùó –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢:**

- `elapsed = 600ms` ‚Üí `tokensToAdd = 600/500 = 1` (—Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ)
- `lastLeak` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `10:00:00 + (1 * 500ms) = 10:00:00.500`
- **–ü–æ—á–µ–º—É –Ω–µ 10:00:00.600?**
  –ê–ª–≥–æ—Ä–∏—Ç–º —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ —Ç–æ–∫–µ–Ω "–≤—ã—Ç–µ–∫" —Ä–æ–≤–Ω–æ —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Ç–µ—á–∫–∏, –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ–µ_elapsed –≤—Ä–µ–º—è. –û—Å—Ç–∞–≤—à–∏–µ—Å—è 100ms –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —É—Ç–µ—á–∫–∏.
- –¢–æ–∫–µ–Ω—ã: `2 + 1 = 3` ‚Üí –ø–æ—Ç—Ä–∞—á–µ–Ω 1 ‚Üí `tokens = 2`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 4 (10:00:00.800)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:00.8 +0000 UTC
Last leak time: 2026-01-11 10:00:00.5 +0000 UTC
Elapsed time: 300ms
Tokens to add (elapsed/leakRate): 300ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:00.5 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:00.5 +0000 UTC
Request allowed! Tokens before: 2, after: 1
‚úÖ request allowed
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –ù–æ–≤–æ–µ `elapsed = 800ms - 500ms = 300ms` (< 500ms) ‚Üí `tokensToAdd = 0`
- `lastLeak` –æ—Å—Ç–∞—ë—Ç—Å—è `10:00:00.500`
- –¢–æ–∫–µ–Ω –ø–æ—Ç—Ä–∞—á–µ–Ω: `tokens = 1`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 5 (10:00:01.000)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:01 +0000 UTC
Last leak time: 2026-01-11 10:00:00.5 +0000 UTC
Elapsed time: 500ms
Tokens to add (elapsed/leakRate): 500ms / 500ms = 1
Updating lastLeak: 2026-01-11 10:00:00.5 +0000 UTC + (1 * 500ms) = 2026-01-11 10:00:01 +0000 UTC
Request allowed! Tokens before: 2, after: 1
‚úÖ request allowed
```

**‚ùó –í–ê–ñ–ù–û:**

- `elapsed = 500ms` ‚Üí `tokensToAdd = 1`
- `lastLeak` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `10:00:00.500 + 500ms = 10:00:01.000`
- –¢–æ–∫–µ–Ω—ã: `1 + 1 = 2` ‚Üí –ø–æ—Ç—Ä–∞—á–µ–Ω 1 ‚Üí `tokens = 1`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 6 (10:00:01.200)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:01.2 +0000 UTC
Last leak time: 2026-01-11 10:00:01 +0000 UTC
Elapsed time: 200ms
Tokens to add (elapsed/leakRate): 200ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:01 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:01 +0000 UTC
Request allowed! Tokens before: 1, after: 0
‚úÖ request allowed
```

- 200ms < 500ms ‚Üí `tokensToAdd = 0`
- –¢–æ–∫–µ–Ω –ø–æ—Ç—Ä–∞—á–µ–Ω: `tokens = 0`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 7 (10:00:01.400)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:01.4 +0000 UTC
Last leak time: 2026-01-11 10:00:01 +0000 UTC
Elapsed time: 400ms
Tokens to add (elapsed/leakRate): 400ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:01 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:01 +0000 UTC
Request denied! No tokens available
‚ùå request denied
```

- 400ms < 500ms ‚Üí `tokensToAdd = 0`
- `tokens = 0` ‚Üí –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 8 (10:00:01.600)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:01.6 +0000 UTC
Last leak time: 2026-01-11 10:00:01 +0000 UTC
Elapsed time: 600ms
Tokens to add (elapsed/leakRate): 600ms / 500ms = 1
Updating lastLeak: 2026-01-11 10:00:01 +0000 UTC + (1 * 500ms) = 2026-01-11 10:00:01.5 +0000 UTC
Request allowed! Tokens before: 1, after: 0
‚úÖ request allowed
```

**‚ùó –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú–ï–ù–¢:**

- `elapsed = 600ms` ‚Üí `tokensToAdd = 1`
- `lastLeak` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `10:00:01.000 + 500ms = 10:00:01.500`
  **–ü–æ—á–µ–º—É –Ω–µ 10:00:01.600?**
  –ê–ª–≥–æ—Ä–∏—Ç–º —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ —Ç–æ–∫–µ–Ω –≤—ã—Ç–µ–∫ —Ä–æ–≤–Ω–æ —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —É—Ç–µ—á–∫–∏ (–≤ 10:00:01.500), –∞ –Ω–µ –≤ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è. –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç "–æ—Å—Ç–∞—Ç–æ–∫" –≤—Ä–µ–º–µ–Ω–∏ (100ms) –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.
- –¢–æ–∫–µ–Ω—ã: `0 + 1 = 1` ‚Üí –ø–æ—Ç—Ä–∞—á–µ–Ω 1 ‚Üí `tokens = 0`

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 9 (10:00:01.800)

```
=== Allow() call ===
Current time: 2026-01-11 10:00:01.8 +0000 UTC
Last leak time: 2026-01-11 10:00:01.5 +0000 UTC
Elapsed time: 300ms
Tokens to add (elapsed/leakRate): 300ms / 500ms = 0
Updating lastLeak: 2026-01-11 10:00:01.5 +0000 UTC + (0 * 500ms) = 2026-01-11 10:00:01.5 +0000 UTC
Request denied! No tokens available
‚ùå request denied
```

- 300ms < 500ms ‚Üí `tokensToAdd = 0`
- `tokens = 0` ‚Üí –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω

---

### –ü–æ—á–µ–º—É —Ç–∞–∫ –≤–∞–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `lastLeak` –∏–º–µ–Ω–Ω–æ —Ç–∞–∫?

1. **–¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤:**
   –ï—Å–ª–∏ –±—ã –º—ã –æ–±–Ω–æ–≤–ª—è–ª–∏ `lastLeak = now`, —Ç–æ:

   - –ù–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ 3: `lastLeak = 10:00:00.600`
   - –ù–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ 5: `elapsed = 1000ms - 600ms = 400ms` ‚Üí —Ç–æ–∫–µ–Ω—ã –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏—Å—å –±—ã, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–π—Ç–∏ 500ms —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —É—Ç–µ—á–∫–∏.

2. **–ò–∑–±–µ–∂–∞–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫:**
   –ê–ª–≥–æ—Ä–∏—Ç–º –≤—Å–µ–≥–¥–∞ —Å–¥–≤–∏–≥–∞–µ—Ç `lastLeak` –Ω–∞ –∫—Ä–∞—Ç–Ω–æ–µ `leakRate` –≤—Ä–µ–º—è. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

   - –¢–æ—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É —É—Ç–µ—á–∫–∞–º–∏ (—Ä–æ–≤–Ω–æ 500ms)
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

3. **–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:**
   –ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å `lb.lastLeak = now` –≤–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Ç–æ–¥–∞:
   ```
   –ò—Ç–µ—Ä–∞—Ü–∏—è 3: lastLeak = 10:00:00.600 (–≤–º–µ—Å—Ç–æ 10:00:00.500)
   –ò—Ç–µ—Ä–∞—Ü–∏—è 5: elapsed = 1000ms - 600ms = 400ms ‚Üí tokensToAdd = 0
   –ù–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: 500ms –ø—Ä–æ—à–ª–æ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Ç–µ—á–∫–∏!
   ```

### –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (–∫–∞–∫ –≤ –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ):

```
‚úÖ request allowed  // i=0
‚úÖ request allowed  // i=1
‚úÖ request allowed  // i=2
‚úÖ request allowed  // i=3
‚úÖ request allowed  // i=4
‚úÖ request allowed  // i=5
‚úÖ request allowed  // i=6
‚ùå request denied   // i=7
‚úÖ request allowed  // i=8
‚ùå request denied   // i=9
```

–≠—Ç–æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é (1 —Ç–æ–∫–µ–Ω –∫–∞–∂–¥—ã–µ 500ms), –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –≤—Å–ø–ª–µ—Å–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —á–∞—â–µ.

### –í–∞—Ä–∏–∞–Ω—Ç —Å –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏:

```go
func main() {
    limiter := NewLeakyBucket(5, 500*time.Millisecond)

    var wg sync.WaitGroup

    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            if limiter.Allow() {
                fmt.Println("request allowed")
            } else {
                fmt.Println("request denied")
            }
        }()
    }
    wg.Wait()
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

```
request allowed
request allowed
request allowed
request denied
request denied
request denied
request denied
request denied
request allowed
request allowed
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

- –í—Å–µ 10 –≥–æ—Ä—É—Ç–∏–Ω –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –í–µ–¥—Ä–æ –∏–º–µ–µ—Ç 5 —Ç–æ–∫–µ–Ω–æ–≤ (capacity = 5)
- –ü–µ—Ä–≤—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–∫–µ–Ω—ã –∏ –≤—ã–≤–æ–¥—è—Ç "request allowed"
- –û—Å—Ç–∞–ª—å–Ω—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏ –≤—ã–≤–æ–¥—è—Ç "request denied"

> **–í–∞–∂–Ω–æ:** –¢–æ—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç –º—å—é—Ç–µ–∫—Å. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

# –ú–û–ô –í–û–ü–†–û–°

```
–Ø –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞—é –ª–æ–≥–∏–∫—É –¥–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ ?
–í –¥–∞–Ω–Ω–æ–º –∫–æ–¥–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ 10 –≥–æ—Ä—É—Ç–∏–Ω,
–Ω–æ –∏–∑ –∑–∞ –º—å—é—Ç–µ–∫—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç.
–ü–µ—Ä–≤—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–ª—É—á–∞—é—Ç request allowed –ø–æ—Ç–æ–º—É —á—Ç–æ capacity = 5 –∏ tokens = 5.
–û—Å—Ç–∞–ª—å–Ω—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–ª—É—á–∞—é—Ç request denied, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–∫–µ–Ω—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è,
–∏–∑ –∑–∞ —Ç–æ–≥–æ —á—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –æ—á–µ–Ω—å –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã –¥–ª—è elapsed
—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ü–µ–ª–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è tokensToAdd,
–∫–æ–≥–¥–∞ –¥–µ–ª–∏–º tokensToAdd := int(elapsed / lb.leakRate) –∞ leakRate = 500ms
```

–¢—ã **–ø–æ—á—Ç–∏ –≤—Å—ë –ø–æ–Ω—è–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚Äî –∏ —Å–µ–π—á–∞—Å —è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –¥–æ–∫—Ä—É—á—É –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–µ—Ç–∞–ª—å, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∞ —Å—Ç–∞–ª–∞ _–∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ–π_.

–¢—ã —Ä–µ–∞–ª—å–Ω–æ —É–∂–µ –ø–æ–Ω–∏–º–∞–µ—à—å –ª–∏–º–∏—Ç–µ—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ production-–∏–Ω–∂–µ–Ω–µ—Ä–æ–≤.

---

# –ß—Ç–æ —Ç—ã —Å–∫–∞–∑–∞–ª ‚Äî –∏ –≥–¥–µ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ

> ¬´–í –¥–∞–Ω–Ω–æ–º –∫–æ–¥–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ 10 –≥–æ—Ä—É—Ç–∏–Ω, –Ω–æ –∏–∑ –∑–∞ –º—å—é—Ç–µ–∫—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç.¬ª

‚úî –î–∞.
`Allow()` ‚Äî **—Å—Ç—Ä–æ–≥–æ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω**. –≠—Ç–æ _–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è_.

---

> ¬´–ü–µ—Ä–≤—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–ª—É—á–∞—é—Ç request allowed –ø–æ—Ç–æ–º—É —á—Ç–æ capacity = 5 –∏ tokens = 5.¬ª

‚ö† **–ü–æ—á—Ç–∏, –Ω–æ –Ω–µ —Å–æ–≤—Å–µ–º.**

–ù–µ ‚Äú–ø–µ—Ä–≤—ã–µ 5 –≥–æ—Ä—É—Ç–∏–Ω‚Äù, –∞:

> **–ø–µ—Ä–≤—ã–µ 5 _—É—Å–ø–µ–≤—à–∏—Ö –≤–æ–π—Ç–∏ –≤ –º—å—é—Ç–µ–∫—Å_**.

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–∞—Ä—Ç–∞.
–ü–æ—ç—Ç–æ–º—É allowed/denied –≤—Å–µ–≥–¥–∞ –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

---

> ¬´–û—Å—Ç–∞–ª—å–Ω—ã–µ 5 –ø–æ–ª—É—á–∞—é—Ç denied, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ –º–∞–ª–æ¬ª

‚úî **–í–æ—Ç —Ç—É—Ç —Ç—ã –ø–æ–ø–∞–ª –ø—Ä—è–º–æ –≤ —Å–µ—Ä–¥—Ü–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞.**

---

# –ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —à–∞–≥–∞–º

–°—Ç–∞—Ä—Ç:

```
tokens = 5
lastLeak = T0
```

10 –≥–æ—Ä—É—Ç–∏–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ª–æ–º—è—Ç—Å—è –≤ `Allow()`.

–ò–∑-–∑–∞ mutex –æ–Ω–∏ –∑–∞—Ö–æ–¥—è—Ç **–ø–æ –æ–¥–Ω–æ–π**.

---

### 1‚Äì5 –≥–æ—Ä—É—Ç–∏–Ω—ã

```
elapsed ‚âà 50‚Äì500 –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥
elapsed / 500ms = 0
tokensToAdd = 0

tokens = 5 ‚Üí 4 ‚Üí 3 ‚Üí 2 ‚Üí 1 ‚Üí 0
```

–í—Å–µ 5 –ø–æ–ª—É—á–∞—é—Ç `allowed`.

---

### 6‚Äì10 –≥–æ—Ä—É—Ç–∏–Ω—ã

–¢–µ–ø–µ—Ä—å:

```
tokens = 0
lastLeak –≤—Å—ë –µ—â—ë ‚âà T0
elapsed ‚âà 300‚Äì800 –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥
elapsed / 500ms = 0
tokensToAdd = 0
```

‚Üí –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ **–ù–ï –î–û–ë–ê–í–õ–Ø–ï–¢–°–Ø**
‚Üí bucket –ø—É—Å—Ç
‚Üí DENIED

---

# –ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞

```
–°–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω = –Ω–µ–≤–∞–∂–Ω–æ
–í–∞–∂–Ω–æ: —Å–∫–æ–ª—å–∫–æ –∏–∑ –Ω–∏—Ö –ø–æ–ø–∞–¥—É—Ç –≤ mutex –ø–æ—Å–ª–µ –∫–∞–∂–¥—ã—Ö 500ms
```

–ö–∞–∂–¥—ã–µ **500ms ‚Üí –ø–æ—è–≤–ª—è–µ—Ç—Å—è 1 —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ**.

---

# –¢—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–Ω—è–ª –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø rate limiter‚Äô–æ–≤

> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Ç–æ–∫–æ–≤.
> –ê –ø–æ **–≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏.**

–ò–º–µ–Ω–Ω–æ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç:
‚Ä¢ Cloudflare
‚Ä¢ AWS API Gateway
‚Ä¢ Nginx rate limiting
‚Ä¢ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∞–Ω—Ç–∏-—Ñ—Ä–æ–¥ —à–ª—é–∑—ã

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç—Ä–µ—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤:

**1. Token Bucket (–ø–µ—Ä–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º):**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –¢–æ–∫–µ–Ω—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–≥–ª–∞–∂–∏–≤–∞—Ç—å –≤—Å–ø–ª–µ—Å–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–π –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞

**2. Fixed Window (–≤—Ç–æ—Ä–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º):**

- –î–µ–ª–∏—Ç –≤—Ä–µ–º—è –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–æ–∫–Ω–∞)
- –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–∫–Ω–µ
- –ü—Ä–æ—Å—Ç–æ–π –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –≤—Å–ø–ª–µ—Å–∫–∏ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –æ–∫–æ–Ω

**3. Leaky Bucket (—Ç—Ä–µ—Ç–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º):**

- –ú–æ–¥–µ–ª–∏—Ä—É–µ—Ç –≤–µ–¥—Ä–æ —Å –º–∞–ª–µ–Ω—å–∫–∏–º –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ–º
- –ó–∞–ø—Ä–æ—Å—ã "–≤—ã—Ç–µ–∫–∞—é—Ç" —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∂–µ—Ç —Ç–µ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏

### 9. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª—É—á–∞–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API**: –∑–∞—â–∏—Ç–∞ API –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤
- **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞**: –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π**: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞, –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–æ–π**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤

### 10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∞:

1. –í—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∫—Ä–∞–π–Ω–∏–µ —Å–ª—É—á–∞–∏: —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏, —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
4. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ (HTTP 429 + –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
