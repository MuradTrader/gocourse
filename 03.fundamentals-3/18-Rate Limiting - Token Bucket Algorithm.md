# **–õ–µ–∫—Ü–∏—è: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Token Bucket Algorithm**

## **–®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É RateLimiter**

```go
package main

import (
    "fmt"
    "time"
)

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ RateLimiter —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º —Ç–æ–∫–µ–Ω–Ω–æ–≥–æ –≤–µ–¥—Ä–∞
type RateLimiter struct {
    tokens    chan struct{}   // –ö–∞–Ω–∞–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (–ø—É—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
    refillTime time.Duration  // –í—Ä–µ–º—è –º–µ–∂–¥—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ —Ç–æ–∫–µ–Ω–æ–≤
}
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

- `tokens chan struct{}` - –∫–∞–Ω–∞–ª –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `struct{}` (0 –±–∞–π—Ç –ø–∞–º—è—Ç–∏)
- `refillTime time.Duration` - –∫–∞–∫ —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã

## **–®–∞–≥ 2: –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ RateLimiter**

```go
// NewRateLimiter —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏
func NewRateLimiter(rateLimit int, refillTime time.Duration) *RateLimiter {
    // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä RateLimiter
    rl := &RateLimiter{
        tokens:    make(chan struct{}, rateLimit),  // –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª
        refillTime: refillTime,
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞–Ω–∞–ª –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
    for i := 0; i < rateLimit; i++ {
        rl.tokens <- struct{}{}  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–æ—Ä—É—Ç–∏–Ω—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    go rl.startRefill()

    return rl
}
```

**–í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏:** –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è, —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.

## **–®–∞–≥ 3: –ú–µ—Ç–æ–¥ startRefill() –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**

```go
// startRefill –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
func (rl *RateLimiter) startRefill() {
    ticker := time.NewTicker(rl.refillTime)  // –¢–∞–π–º–µ—Ä –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    defer ticker.Stop()  // –û—Å—Ç–∞–Ω–æ–≤–∏–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

    for {
        select {
        case <-ticker.C:  // –ö–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
            // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–∞–Ω–∞–ª
            select {
            case rl.tokens <- struct{}{}:  // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ - –¥–æ–±–∞–≤–ª—è–µ–º
                // –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            default:
                // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –ø–æ–ª–æ–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            }
        }
    }
}
```

## **–®–∞–≥ 4: –ú–µ—Ç–æ–¥ Allow() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞**

```go
// Allow –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ç–æ–∫–µ–Ω
func (rl *RateLimiter) Allow() bool {
    select {
    case <-rl.tokens:  // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ –∫–∞–Ω–∞–ª–∞
        return true    // –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω - –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
    default:
        return false   // –¢–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç - –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
    }
}
```

## **–®–∞–≥ 5: –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

```go
func main() {
    fmt.Println("=== TOKEN BUCKET RATE LIMITER ===")
    fmt.Println("–õ–∏–º–∏—Ç: 5 –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: 1 —Ç–æ–∫–µ–Ω –≤ —Å–µ–∫—É–Ω–¥—É")
    fmt.Println("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 200ms")
    fmt.Println("=================================")

    // –°–æ–∑–¥–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å: 5 –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    rateLimiter := NewRateLimiter(5, time.Second)

    // –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å 10 –∑–∞–ø—Ä–æ—Å–æ–≤
    for i := 1; i <= 10; i++ {
        time.Sleep(200 * time.Millisecond)  // –ó–∞–¥–µ—Ä–∂–∫–∞ 200ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

        if rateLimiter.Allow() {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì\n", i)
        } else {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó\n", i)
        }
    }
}
```

## **–®–∞–≥ 6: –ü–æ–ª–Ω—ã–π –∫–æ–¥ –∏ –µ–≥–æ –≤—ã–≤–æ–¥**

```go
package main

import (
    "fmt"
    "time"
)

type RateLimiter struct {
    tokens    chan struct{}
    refillTime time.Duration
}

func NewRateLimiter(rateLimit int, refillTime time.Duration) *RateLimiter {
    rl := &RateLimiter{
        tokens:    make(chan struct{}, rateLimit),
        refillTime: refillTime,
    }

    for i := 0; i < rateLimit; i++ {
        rl.tokens <- struct{}{}
    }

    go rl.startRefill()

    return rl
}

func (rl *RateLimiter) startRefill() {
    ticker := time.NewTicker(rl.refillTime)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            select {
            case rl.tokens <- struct{}{}:
            default:
            }
        }
    }
}

func (rl *RateLimiter) Allow() bool {
    select {
    case <-rl.tokens:
        return true
    default:
        return false
    }
}

func main() {
    fmt.Println("=== TOKEN BUCKET RATE LIMITER ===")
    fmt.Println("–õ–∏–º–∏—Ç: 5 –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: 1 —Ç–æ–∫–µ–Ω –≤ —Å–µ–∫—É–Ω–¥—É")
    fmt.Println("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 200ms")
    fmt.Println("=================================")

    rateLimiter := NewRateLimiter(5, time.Second)

    for i := 1; i <= 10; i++ {
        time.Sleep(200 * time.Millisecond)

        if rateLimiter.Allow() {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì\n", i)
        } else {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó\n", i)
        }
    }
}
```

**–í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏:**

```
=== TOKEN BUCKET RATE LIMITER ===
–õ–∏–º–∏—Ç: 5 –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: 1 —Ç–æ–∫–µ–Ω –≤ —Å–µ–∫—É–Ω–¥—É
–û—Ç–ø—Ä–∞–≤–ª—è–µ–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 200ms
=================================
–ó–∞–ø—Ä–æ—Å 1: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 2: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 3: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 4: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 5: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 6: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 7: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó
–ó–∞–ø—Ä–æ—Å 8: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó
–ó–∞–ø—Ä–æ—Å 9: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó
–ó–∞–ø—Ä–æ—Å 10: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
```

## **–®–∞–≥ 7: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –ø–æ–ª—É—á–∏–ª–æ—Å—å 6 —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**

# üß† –ò–¥–µ—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Token Bucket

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –≤–µ–¥—Ä–æ —Å –∂–µ—Ç–æ–Ω–∞–º–∏:

- –í–µ–¥—Ä–æ –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Å–∏–º—É–º `N` —Ç–æ–∫–µ–Ω–æ–≤
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å **–∑–∞–±–∏—Ä–∞–µ—Ç 1 —Ç–æ–∫–µ–Ω**
- –†–∞–∑ –≤ `T` —Å–µ–∫—É–Ω–¥ –≤ –≤–µ–¥—Ä–æ **–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è 1 —Ç–æ–∫–µ–Ω**
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç ‚Üí –∑–∞–ø—Ä–æ—Å **–æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è**

---

# –†–∞–∑–±–æ—Ä –ø–æ—Å—Ç—Ä–æ—á–Ω–æ

---

## `type RateLimiter struct`

```go
type RateLimiter struct {
	tokens     chan struct{}
	refillTime time.Duration
}
```

| –ü–æ–ª–µ         | –ß—Ç–æ –∑–Ω–∞—á–∏—Ç                                                                      |
| ------------ | ------------------------------------------------------------------------------- |
| `tokens`     | –ö–∞–Ω–∞–ª-–≤–µ–¥—Ä–æ —Å —Ç–æ–∫–µ–Ω–∞–º–∏                                                          |
| `struct{}`   | –ü—É—Å—Ç–æ–π —Ç–∏–ø (0 –±–∞–π—Ç) ‚Äî –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ, –Ω–∞–º –≤–∞–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç ¬´–µ—Å—Ç—å —Ç–æ–∫–µ–Ω¬ª |
| `refillTime` | –ö–∞–∫ —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã                                                |

üìå –ö–∞–Ω–∞–ª —Å –±—É—Ñ–µ—Ä–æ–º = **—Å—á—ë—Ç—á–∏–∫ —Ä–µ—Å—É—Ä—Å–æ–≤**

---

## –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```go
func NewRateLimiter(rateLimit int, refillTime time.Duration) *RateLimiter {
```

–°–æ–∑–¥–∞—ë—Ç –ª–∏–º–∏—Ç–µ—Ä.

---

```go
rl := &RateLimiter{
	tokens:     make(chan struct{}, rateLimit),
	refillTime: refillTime,
}
```

–°–æ–∑–¥–∞—ë—Ç—Å—è **–±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é `rateLimit`**

–ü—Ä–∏–º–µ—Ä:

```
make(chan struct{}, 5)
```

‚Äî —ç—Ç–æ –≤–µ–¥—Ä–æ –º–∞–∫—Å–∏–º—É–º –Ω–∞ 5 —Ç–æ–∫–µ–Ω–æ–≤.

---

### –ù–∞–ø–æ–ª–Ω—è–µ–º –≤–µ–¥—Ä–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

```go
for i := 0; i < rateLimit; i++ {
	rl.tokens <- struct{}{}
}
```

–ö–ª–∞–¥—ë–º –≤ –∫–∞–Ω–∞–ª 5 —Ç–æ–∫–µ–Ω–æ–≤:

```
[t][t][t][t][t]
```

---

### –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –≥–æ—Ä—É—Ç–∏–Ω—É-–¥–æ–∑–∞–ø—Ä–∞–≤—â–∏–∫

```go
go rl.startRefill()
```

–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–∫–µ–Ω—ã —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É.

---

## –ì–æ—Ä—É—Ç–∏–Ω—É-–∑–∞–ø—Ä–∞–≤—â–∏–∫

```go
func (rl *RateLimiter) startRefill() {
	ticker := time.NewTicker(rl.refillTime)
	defer ticker.Stop()
```

–°–æ–∑–¥–∞—ë—Ç—Å—è —Ç–∞–π–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∂–¥—ã–µ `refillTime` (1 —Å–µ–∫) —à–ª—ë—Ç —Å–æ–±—ã—Ç–∏–µ –≤ `ticker.C`

---

### –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª

```go
for {
	select {
	case <-ticker.C:
```

–ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É —Å—é–¥–∞ –ø–æ–ø–∞–¥–∞–µ–º.

---

### –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å 1 —Ç–æ–∫–µ–Ω

```go
select {
case rl.tokens <- struct{}{}:
default:
}
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:**

| –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç                                               | –ü–æ—á–µ–º—É |
| ------------------------------------------------------------ | ------ |
| –ï—Å–ª–∏ –≤ –∫–∞–Ω–∞–ª–µ –µ—Å—Ç—å –º–µ—Å—Ç–æ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–∫–µ–Ω                 |        |
| –ï—Å–ª–∏ –∫–∞–Ω–∞–ª –ø–æ–ª–Ω—ã–π ‚Üí `default` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º |        |

üí° –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –≤–µ–¥—Ä–∞.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞

```go
func (rl *RateLimiter) Allow() bool {
```

---

```go
select {
case <-rl.tokens:
	return true
default:
	return false
}
```

| –°–ª—É—á–∞–π                | –ß—Ç–æ –∑–Ω–∞—á–∏—Ç                   |
| --------------------- | ---------------------------- |
| –ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –∫–∞–Ω–∞–ª–∞ | –ï—Å—Ç—å —Ç–æ–∫–µ–Ω ‚Üí –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à—ë–Ω |
| –ö–∞–Ω–∞–ª –ø—É—Å—Ç            | –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –æ—Ç–∫–ª–æ–Ω—ë–Ω       |

üîí –≠—Ç–æ **–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** ‚Äì –Ω–∏–∫–∞–∫–∏–µ –≥–æ–Ω–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã.

---

# –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `main`

```go
rateLimiter := NewRateLimiter(5, time.Second)
```

–í–µ–¥—Ä–æ:

```
[t][t][t][t][t]
```

---

–ö–∞–∂–¥—ã–µ `200ms` –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:

| –í—Ä–µ–º—è              | –¢–æ–∫–µ–Ω—ã | –†–µ–∑—É–ª—å—Ç–∞—Ç |
| ------------------ | ------ | --------- |
| 0.2s               | 5‚Üí4    | ‚úì         |
| 0.4s               | 4‚Üí3    | ‚úì         |
| 0.6s               | 3‚Üí2    | ‚úì         |
| 0.8s               | 2‚Üí1    | ‚úì         |
| 1.0s               | 1‚Üí0    | ‚úì         |
| **1.0s refill +1** | 0‚Üí1    |           |
| 1.2s               | 1‚Üí0    | ‚úì         |
| 1.4s               | 0      | ‚úó         |
| 1.6s               | 0      | ‚úó         |
| 1.8s               | 0      | ‚úó         |
| **2.0s refill +1** | 0‚Üí1    |           |
| 2.0s               | 1‚Üí0    | ‚úì         |

‚Üí –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ç–≤–æ–π –≤—ã–≤–æ–¥ ‚úî

---

# –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –≥–µ–Ω–∏–∞–ª—å–Ω–æ

| –ü—Ä–∏—á–∏–Ω–∞                  |
| ------------------------ |
| –ë–µ–∑ mutex                |
| –ë–µ–∑ atomic               |
| –ë–µ–∑ race                 |
| –ö–∞–Ω–∞–ª = —Å—á—ë—Ç—á–∏–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ |
| –ò–¥–µ–∞–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è  |

---

# –ì–¥–µ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

- API Gateways
- –ê–Ω—Ç–∏-DDoS
- Payment services
- Crypto –±–∏—Ä–∂–∏
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —à–ª—é–∑—ã

## **–®–∞–≥ 8: –ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `struct{}`?**

```go
// –ü—Ä–∏–º–µ—Ä –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
func demonstrateEmptyStruct() {
    fmt.Println("\n=== –ü–æ—á–µ–º—É struct{}? ===")

    // –†–∞–∑–º–µ—Ä —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤ –ø–∞–º—è—Ç–∏
    var s struct{}
    var b bool
    var i int

    fmt.Printf("–†–∞–∑–º–µ—Ä struct{}: %d –±–∞–π—Ç\n", s)
    fmt.Printf("–†–∞–∑–º–µ—Ä bool: %d –±–∞–π—Ç\n", b)
    fmt.Printf("–†–∞–∑–º–µ—Ä int: %d –±–∞–π—Ç\n", i)

    fmt.Println("\n–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ struct{}:")
    fmt.Println("1. 0 –±–∞–π—Ç –ø–∞–º—è—Ç–∏")
    fmt.Println("2. –ß–µ—Ç–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω—É–∂–Ω—ã")
    fmt.Println("3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏")
}
```

**–í—ã–≤–æ–¥:**

```
=== –ü–æ—á–µ–º—É struct{}? ===
–†–∞–∑–º–µ—Ä struct{}: {} –±–∞–π—Ç
–†–∞–∑–º–µ—Ä bool: false –±–∞–π—Ç
–†–∞–∑–º–µ—Ä int: 0 –±–∞–π—Ç

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ struct{}:
1. 0 –±–∞–π—Ç –ø–∞–º—è—Ç–∏
2. –ß–µ—Ç–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω—É–∂–Ω—ã
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
```

## **–®–∞–≥ 9: –¢–µ—Å—Ç —Å –¥—Ä—É–≥–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º (300ms)**

```go
func testWith300ms() {
    fmt.Println("\n=== –¢–µ—Å—Ç —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 300ms ===")

    rateLimiter := NewRateLimiter(5, time.Second)

    for i := 1; i <= 10; i++ {
        time.Sleep(300 * time.Millisecond)

        if rateLimiter.Allow() {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì\n", i)
        } else {
            fmt.Printf("–ó–∞–ø—Ä–æ—Å %d: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó\n", i)
        }
    }
}
```

**–í—ã–≤–æ–¥:**

```
=== –¢–µ—Å—Ç —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 300ms ===
=================================
–ó–∞–ø—Ä–æ—Å 1: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 2: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 3: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 4: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 5: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 6: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 7: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
–ó–∞–ø—Ä–æ—Å 8: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó
–ó–∞–ø—Ä–æ—Å 9: –û—Ç–∫–ª–æ–Ω–µ–Ω ‚úó
–ó–∞–ø—Ä–æ—Å 10: –†–∞–∑—Ä–µ—à–µ–Ω ‚úì
```

–†–∞–∑–±–µ—Ä—ë–º –≤–∞—Ä–∏–∞–Ω—Ç **300ms** –ø–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º –∫–∞–∫ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É CPU.

---

# –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ         |
| -------- | ---------------- |
| –í–µ–¥—Ä–æ    | 5 —Ç–æ–∫–µ–Ω–æ–≤        |
| Refill   | +1 —Ç–æ–∫–µ–Ω / 1 —Å–µ–∫ |
| –ó–∞–ø—Ä–æ—Å—ã  | –∫–∞–∂–¥—ã–µ **300ms** |
| –í—Å–µ–≥–æ    | 10 –∑–∞–ø—Ä–æ—Å–æ–≤      |

---

# –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ:

```
[t][t][t][t][t]
```

---

| –ó–∞–ø—Ä–æ—Å | –í—Ä–µ–º—è    | –¢–æ–∫–µ–Ω—ã –î–û | Refill | –¢–æ–∫–µ–Ω—ã –ü–û–°–õ–ï | –ò—Ç–æ–≥   |
| ------ | -------- | --------- | ------ | ------------ | ------ |
| 1      | 0.3s     | 5         | ‚Äî      | 4            | ‚úì      |
| 2      | 0.6s     | 4         | ‚Äî      | 3            | ‚úì      |
| 3      | 0.9s     | 3         | ‚Äî      | 2            | ‚úì      |
| **‚Äî**  | **1.0s** | 2         | +1     | 3            | refill |
| 4      | 1.2s     | 3         | ‚Äî      | 2            | ‚úì      |
| 5      | 1.5s     | 2         | ‚Äî      | 1            | ‚úì      |
| 6      | 1.8s     | 1         | ‚Äî      | 0            | ‚úì      |
| **‚Äî**  | **2.0s** | 0         | +1     | 1            | refill |
| 7      | 2.1s     | 1         | ‚Äî      | 0            | ‚úì      |
| 8      | 2.4s     | 0         | ‚Äî      | 0            | ‚úó      |
| 9      | 2.7s     | 0         | ‚Äî      | 0            | ‚úó      |
| **‚Äî**  | **3.0s** | 0         | +1     | 1            | refill |
| 10     | 3.0s     | 1         | ‚Äî      | 0            | ‚úì      |

üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

```
‚úì ‚úì ‚úì ‚úì ‚úì ‚úì ‚úì ‚úó ‚úó ‚úì
```

---

# –ü–æ—á–µ–º—É 7-–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç?

–ü–æ—Ç–æ–º—É —á—Ç–æ:

- –ó–∞ –ø–µ—Ä–≤—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã refill –¥–æ–±–∞–≤–∏–ª **2 —Ç–æ–∫–µ–Ω–∞**
- –ê –º—ã —É—Å–ø–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å **7 —Ç–æ–∫–µ–Ω–æ–≤**

```
5 —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö + 2 refill = 7
```

‚Üí –ø–æ—ç—Ç–æ–º—É —Ä–æ–≤–Ω–æ 7 —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.

---

# –ü–æ—á–µ–º—É 8 –∏ 9 –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è?

–ü–æ—Ç–æ–º—É —á—Ç–æ:

- —Ç–æ–∫–µ–Ω–æ–≤ 0
- refill –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 3-–π —Å–µ–∫—É–Ω–¥–µ
- –∞ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º refill

---

# –ü–æ—á–µ–º—É 10-–π —Ä–∞–∑—Ä–µ—à—ë–Ω?

–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç **–≤ –º–æ–º–µ–Ω—Ç refill 3.0s**, –∏ —Ç–æ–∫–µ–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –±—É–∫–≤–∞–ª—å–Ω–æ –≤ —Ç—É –∂–µ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—É.

---

# –§–æ—Ä–º—É–ª–∞ –ª–∏–º–∏—Ç–∞

–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:

```
1 —Ç–æ–∫–µ–Ω / 1 —Å–µ–∫ = 1 RPS
```

–ê —Ç—ã —à–ª—ë—à—å:

```
1 –∑–∞–ø—Ä–æ—Å / 300ms ‚âà 3.33 RPS
```

‚Üí –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—à—å –ª–∏–º–∏—Ç–µ—Ä ‚Üí –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –æ—Ç–∫–∞–∑—ã.

---

# –ü–æ—á–µ–º—É —ç—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ

–≠—Ç–æ —Ä–æ–≤–Ω–æ —Ç–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç:

- API Gateways
- Binance / Bybit
- Cloudflare
- Kubernetes API

## **–ò—Ç–æ–≥ —Ä–∞–±–æ—Ç—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞:**

1. **Token Bucket Algorithm** –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ë—É—Ñ–µ—Ä —Ç–æ–∫–µ–Ω–æ–≤** (–∫–∞–Ω–∞–ª) —Ö—Ä–∞–Ω–∏—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
3. **–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
4. **Allow()** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
5. **–ü—É—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** `struct{}` –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤

**–ö–ª—é—á–µ–≤–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å–ø–ª–µ—Å–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–æ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞), –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.

# –í–ê–ñ–ù–û

**–ú–æ–π –≤–æ–ø—Ä–æ—Å:**

```
–ê –ø–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º–∞ startRefill –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∏ –∫–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç defer ticker.Stop() ?

func (rl *RateLimiter) startRefill() {
	ticker := time.NewTicker(rl.refillTime)
	defer ticker.Stop()

	for {
		select {
		case <-ticker.C:
			select {
			case rl.tokens <- struct{}{}:
			default:
			}
		}
	}
}
```

---

# ‚ùó –ì–ª–∞–≤–Ω–∞—è –ø—Ä–∞–≤–¥–∞

### –≠—Ç–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ **–ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å–∞–º–∞.**

```go
for {
    ...
}
```

‚Üí —ç—Ç–æ **–≤–µ—á–Ω—ã–π —Ü–∏–∫–ª**
‚Üí `startRefill()` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–π–¥–µ—Ç –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏**
‚Üí `defer ticker.Stop()` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è**
(–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —É–º—Ä—ë—Ç —Ü–µ–ª–∏–∫–æ–º)

---

# –ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

```
go rl.startRefill()
```

Runtime —Å–æ–∑–¥–∞—ë—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–µ–∫, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –µ—ë –∏ –æ–Ω–∞ –∫—Ä—É—Ç–∏—Ç—Å—è:

```
while(process alive) {
    wait ticker
    try add token
}
```

–ü–æ–∫–∞ **–∂–∏–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –∂–∏–≤–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞**.

---

# –ö–æ–≥–¥–∞ –æ–Ω–∞ —É–º–∏—Ä–∞–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ

–¢–æ–ª—å–∫–æ —Ç—É—Ç:

```
main() -> return
‚Üí runtime.exit()
‚Üí kill all goroutines
```

–ò —Ç–æ–≥–¥–∞:

- ticker.Stop() –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- defer –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

–ü—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —É–º–∏—Ä–∞–µ—Ç.

---

# –ü–æ—á–µ–º—É defer —Ç—É—Ç –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω

`defer` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏**, –∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ—Ç.

---

# –ü–æ—ç—Ç–æ–º—É –≤ production-–∫–æ–¥–µ –¢–ê–ö –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞—é—Ç

–≠—Ç–æ —É—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä.

–í —Ä–µ–∞–ª—å–Ω–æ–º API —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–ª–∞—é—Ç —Ç–∞–∫:

```go
func (rl *RateLimiter) startRefill(ctx context.Context, wg *sync.WaitGroup) {
    defer wg.Done()
    ticker := time.NewTicker(rl.refillTime)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            select {
            case rl.tokens <- struct{}{}:
            default:
            }
        case <-ctx.Done():
            return   // ‚Üê –í–û–¢ –¢–£–¢ defer –°–†–ê–ë–ê–¢–´–í–ê–ï–¢
        }
    }
}
```

–ò –∑–∞–ø—É—Å–∫:

```go
ctx, cancel := context.WithCancel(context.Background())
wg.Add(1)
go rl.startRefill(ctx, &wg)

...
cancel()
wg.Wait()
```

‚Üí ticker –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
‚Üí –≥–æ—Ä—É—Ç–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
‚Üí –ø–∞–º—è—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è
‚Üí —É—Ç–µ—á–µ–∫ –Ω–µ—Ç

---

# –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è

| –ú–∏—Ñ                              | –ü—Ä–∞–≤–¥–∞ |
| -------------------------------- | ------ |
| defer –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è         | ‚ùå     |
| defer —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ return | ‚úÖ     |
| infinite goroutine ‚Äî —É—Ç–µ—á–∫–∞      | ‚úÖ     |
| main –∂–¥—ë—Ç –≥–æ—Ä—É—Ç–∏–Ω—ã               | ‚ùå     |
